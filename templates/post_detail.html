<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title }}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/post_detail.css' %}">

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        let modal = document.getElementById("modal-message");
        let closeButton = document.getElementById("close-modal");

        if (modal && closeButton) {
            closeButton.onclick = function() {
                modal.style.display = "none";
            };

            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            };
        }

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞
        document.querySelectorAll(".reply-button").forEach(button => {
            button.addEventListener("click", function() {
                let commentId = this.dataset.commentId;
                let form = document.getElementById("reply-form-" + commentId);
                if (form.style.display === "none" || form.style.display === "") {
                    form.style.display = "block";
                } else {
                    form.style.display = "none";
                }
            });
        });
    });
    </script>

</head>
<body>
    <header>
        <h1>{{ post.title }}</h1>
    </header>

    <main>
        <div class="post">
            <h2>{{ post.title }}</h2>
            <p class="post-author">–ê–≤—Ç–æ—Ä: {{ post.author.username }}</p>
            <div class="post-text-container">
                <p>{{ post.text }}</p>
            </div>

            <div class="like-dislike">
                <form action="{% url 'like_post' post.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit"
                            {% if user in post.liked_users.all %}
                                style="background-color: #4CAF50; color: white;"
                            {% endif %}>
                        üëç {{ post.likes_count }}
                    </button>
                </form>

                <form action="{% url 'dislike_post' post.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit"
                            {% if user in post.disliked_users.all %}
                                style="background-color: #d32f2f; color: white;"
                            {% endif %}>
                        üëé {{ post.dislikes_count }}
                    </button>
                </form>
            </div>

            <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            <div class="comments">
                {% for comment in comments %}
                    {% if not comment.parent %}
                        <div class="comment">
                            <p><strong>{{ comment.author.username }}</strong> ({{ comment.created_at }})</p>
                            <p>{{ comment.text }}</p>

                            <!-- –ö–Ω–æ–ø–∫–∞ "–û—Ç–≤–µ—Ç–∏—Ç—å" -->
                            {% if user.is_authenticated %}
                                <button class="reply-button" data-comment-id="{{ comment.id }}">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                            {% endif %}

                            {% if user == comment.author %}
                                <form method="POST" action="{% url 'delcomment' post.id comment.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" name="delcomment" style="background-color: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer;">
                                        –£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                                    </button>
                                </form>
                            {% endif %}

                            <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞) -->
                            {% if user.is_authenticated %}
                                <form method="POST" class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                                    {% csrf_token %}
                                    <input type="hidden" name="parent" value="{{ comment.id }}">
                                    {{ form.as_p }}
                                    <button type="submit">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                                </form>
                            {% endif %}

                            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å) -->
                            <div class="replies">
                                {% for reply in comment.replies.all %}
                                    <div class="reply">
                                        <p><strong>{{ reply.author.username }}</strong> ({{ reply.created_at }})</p>
                                        <p>{{ reply.text }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% empty %}
                    <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç</p>
                {% endfor %}
            </div>

            {% if user.is_authenticated %}
                <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
                <form method="POST">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" name="addcomment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            {% else %}
                <p>–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'register' %}">–≤–æ–π–¥–∏—Ç–µ</a>.</p>
            {% endif %}

            <div class="post-actions">
                <a href="{% url 'editpost' post.id %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é</a>
                <a href="{% url 'deletepost' post.id %}">–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é</a>
                <a href="{% url 'main' %}">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </main>

    {% if messages %}
        <div id="modal-message" class="modal">
            <div class="modal-content">
                {% for message in messages %}
                    {% if 'root_error' in message.tags %}
                        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
                <button id="close-modal">OK</button>
            </div>
        </div>
    {% endif %}
</body>
</html>
